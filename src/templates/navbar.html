<script>
  $(document).ready( function () {
    let playerRoot = generateTrie('{{players|tojson|safe}}');
    let teamRoot = generateTrie('{{teams|tojson|safe}}');
    let leagueRoot = generateTrie('{{leagues|tojson|safe}}');
    let searchDP = new Map();

    function title(words) {
      let wordList = words.split(" ");
      for (let i = 0; i < wordList.length; i++) {
        wordList[i] = wordList[i].charAt(0).toUpperCase() + wordList[i].slice(1);
      }
      return wordList.join(' ');
    }

    function displayResults(searchResults, section) {
      let dropdown = document.getElementById("search-dropdown");
      // add section name divider
      if (searchResults.length > 0) {
        let sectionNameRow = document.createElement("div");
        sectionNameRow.setAttribute("class", "list-group-item p-2 search-section");
        let sectionName = document.createElement("strong");
        sectionName.setAttribute("class", "text-success");
        sectionName.appendChild(document.createTextNode(section));
        sectionNameRow.appendChild(sectionName);
        dropdown.appendChild(sectionNameRow);
      }
      for (let result of searchResults) {
        // CSS for result row
        let itemLink = document.createElement("a");
        itemLink.setAttribute("class", "list-group-item list-group-item-action p-2 search-name");
        // CSS for result image           
        let itemLogo;
        if (result.hasOwnProperty("logo")) {
          itemLogo = document.createElement("img");
          itemLogo.setAttribute("class", "float-left");
          itemLogo.setAttribute("height", "20px");
          itemLogo.setAttribute("width", "20px");
          itemLogo.setAttribute("src", result.logo);
        } else {
          itemLogo = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          itemLogo.setAttribute("viewBox", "0 0 16 16");
          itemLogo.setAttribute("height", "1.5em");
          itemLogo.setAttribute("width", "1.5em");
          itemLogo.setAttribute("class", "float-left bi bi-person-fill");
          itemLogo.setAttribute("fill", "currentColor");
          itemLogo.setAttribute("xmlns", "http://www.w3.org/2000/svg");
          let itemLogoPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
          itemLogoPath.setAttribute("fill-rule", "evenodd");
          itemLogoPath.setAttribute("d", "M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z");
          itemLogo.appendChild(itemLogoPath);
        }
        // CSS for result row link/text
        // league and team URL
        let searchType = section.slice(0, section.length - 1).toLowerCase();
        let newUrl;
        if (searchType === "league" || searchType === "team") {
          newUrl = (
            window.location.href.split("/")[0] 
            + "/" 
            + searchType 
            + "/"
            + result.id.toString()
            + "/season/{{current_season}}" 
          );
        // player URLs
        } else {
          newUrl = (
            window.location.href.split("/")[0] 
            + "/" 
            + searchType 
            + "/" 
            + result.id.toString()
          );
        }
        itemLink.setAttribute("onClick", "window.location.href = '" + newUrl + "'");
        let itemName = document.createElement("strong");
        itemName.setAttribute("class", "float-right mx-2");
        itemName.appendChild(document.createTextNode(title(result.name)));
        // add item to dropdown
        itemLink.appendChild(itemName);
        itemLink.appendChild(itemLogo);
        dropdown.appendChild(itemLink);
      }
    }

    $("#nav-search").keyup( function () {
      let searchQuery = $(this).val();

      // set CSS for dropdown 
      let dropdown = document.getElementById("search-dropdown");
      let parentPos = document.getElementById("nav-search").getBoundingClientRect();
      // delete previous results in dropdown
      while (dropdown.firstChild) {
        dropdown.removeChild(dropdown.firstChild);
      }

      // search trie or return stored result
      if (searchDP.has(searchQuery)) {
        let results = searchDP.get(searchQuery);
        // get player results
        displayResults(results.players, "PLAYERS");
        // get team results
        displayResults(results.teams, "TEAMS");
        // get league results
        displayResults(results.leagues, "LEAGUES");
      } else {
        // get player results
        let playerResults = searchTrie(searchQuery, playerRoot);
        displayResults(playerResults, "PLAYERS");
        // get team results
        let teamResults = searchTrie(searchQuery, teamRoot);
        displayResults(teamResults, "TEAMS");
        // get league results
        let leagueResults = searchTrie(searchQuery, leagueRoot);
        displayResults(leagueResults, "LEAGUES");
        // add results to DP
        searchDP.set(
          searchQuery,
          {
            "players": playerResults,
            "teams": teamResults,
            "leagues": leagueResults
          }
        );
      }
    });
  });
</script>
<nav class="navbar navbar-light navbar-fixed-top bg-light border-bottom navbar-expand-lg align-items-center p-0"
  id="main-nav">
    <!-- Logo -->
    <a class="navbar-brand text-secondary pr-0" id="brand"
      href="{{ url_for('home') }}">
        <strong>info-rm</strong>
    </a>
    <button class="navbar-toggler mr-3" type="button" data-toggle="collapse"
      data-target="#main-nav-collapse" aria-controls="main-nav-collapse"
      aria-expanded="false" aria-label="Toggle navigation" id="navbar-collapse-button">
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Collapse Div Start -->
    {% if search_query %}
      <div class="navbar-collapse collapse show text-left border-left mr-0" id="main-nav-collapse">
    {% else %}
      <div class="navbar-collapse collapse text-left border-left mr-0" id="main-nav-collapse">
    {% endif %}
	      <!-- Builder -->
        <a class="nav-item nav-link text-secondary px-0 ml-0" id="builder-link"
	         href="{{ url_for('builder') }}">
             StatBuilder
             {% include "builder_icon.html" %}
        </a>
        <!-- Player Search -->
	      <div id="search-wrapper">
	        <form class="form-inline dropdown" autocomplete="off">
            <input class="form-control form-control-sm" 
              type="search"
              placeholder="Search" 
              aria-label="Search" 
              id="nav-search">
		        </input>
	          <ul class="list-group dropdown-menu p-0" id="search-dropdown"></ul>
	        </form>
	      </div>
        <!-- Leagues -->
	<div class="flex-column">
          {% include "league_nav.html" %}
	</div>
      </div>
  <!-- Collapse Div End -->
</nav>
